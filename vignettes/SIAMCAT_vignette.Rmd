---
title: "SIAMCAT: Statistical Inference of Associations between Microbial Communities And host phenoTypes"
author: "Konrad Zych, Jakob Wirbel, Nicolai Karcher, and Georg Zeller"
date: "2018-01-02"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SIAMCAT}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

Tjos 

## SIAMCAT Workflow

```{r message=FALSE, warning=FALSE}
library(SIAMCAT)
fn.in.feat  <- system.file("extdata", "feat_crc_study-pop-I_N141_tax_profile_mocat_bn_specI_clusters.tsv", package = "SIAMCAT")
fn.in.label <- system.file("extdata", "label_crc_study-pop-I_N141_tax_profile_mocat_bn_specI_clusters.tsv", package = "SIAMCAT")
fn.in.meta  <- system.file("extdata", "num_metadata_crc_study-pop-I_N141_tax_profile_mocat_bn_specI_clusters.tsv", package = "SIAMCAT")
```

### Read/Validate/Filter Data

```{r}
feat  <- read.features(fn.in.feat)
label <- read.labels(fn.in.label)
meta  <- read.meta(fn.in.meta)
siamcat <- siamcat(feat, label, meta)
```
#add workflow from a disk
#keep in mind holdout prediction
#check dtaa consistency function
#CI low abudandt accuracy
```{r}
siamcat <- validate.data(siamcat)
```

```{r}
siamcat <- select.samples(siamcat, 
                          filter='age', 
                          allowed.set=NULL, 
                          allowed.range=c(0,120), verbose=1)

```

```{r}
siamcat <- filter.feat(siamcat,  
                       filter.method = 'abundance', 
                       cutoff =0.001, 
                       recomp.prop = FALSE, 
                       rm.unmapped = TRUE)
```

### Association/Confounder Testing

```{r}
check.confounders(siamcat, fn.plot='conf_check.pdf')
```

```{r}
check.associations(siamcat,
                   sort.by='fc',
                   fn.plot = 'assoc.pdf',
                   alpha = 0.05, mult.corr = "fdr",
                   detect.lim = 10^-6, max.show = 50, plot.type = "quantile.box",
                   panels=c("fc", "prevalence", "auroc"))
```

### Data Normalization

```{r}
siamcat <- normalize.feat(siamcat, 
                          norm.method = "log.unit", 
                          norm.param=list(log.n0 = 1e-06, n.p=2, norm.margin=1))
```

### Model building and Prediction

```{r}
pred.names = strsplit(c('fobt'), ',', fixed=TRUE)[[1]]
siamcat <- add.meta.pred(siamcat, 
                          pred.names = pred.names, 
                          std.meta = TRUE,verbose=3)
```
### vignette for cv/holdout
### int verbose for each function (0,5) with def=1
```{r}
siamcat <- data.splitter(siamcat, 
                            num.folds = 10, ### holdout -> all train/ all test etc, cross-validation/holdout -> make rest defaults
                            num.resample = 10, 
                            stratify = TRUE, 
                            inseparable = NULL)
```

```{r}
siamcat <- train.model(siamcat, 
                       method = "lasso_ll",
                       data.split=data.split, #??
                       stratify = TRUE,
                       modsel.crit=list("pr"),  
                       min.nonzero.coeff = 5,
                       param.set=NULL)
```

```{r}
siamcat <- make.predictions(siamcat)
```

### Model Evaluation and Interpretation

```{r}
siamcat <-  evaluate.predictions(siamcat)

evaluation.model.plot(siamcat,'eval_plot.pdf')
```

```{r}
interpretor.model.plot(siamcat,
                        fn.plot='interpretation.pdf',
                        consens.thres = 0.5,
                        norm.models = TRUE,
                        limits=c(-5,5),
                        heatmap.type = 'fc',
                       verbose=3)
```
